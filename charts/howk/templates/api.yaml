apiVersion: v1
kind: Service
metadata:
  name: {{ include "howk.fullname" . }}-api
  labels:
    {{- include "howk.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  selector:
    {{- include "howk.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: api
  ports:
    - port: {{ .Values.api.service.port }}
      targetPort: http
      name: http
      {{- if eq .Values.api.service.type "NodePort" }}
      nodePort: {{ .Values.api.service.nodePort }}
      {{- end }}
  type: {{ .Values.api.service.type }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "howk.fullname" . }}-api
  labels:
    {{- include "howk.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
{{- if and .Values.config.transformer.enabled .Values.configmapReload.enabled (eq .Values.configmapReload.method "annotation") }}
  annotations:
    # These annotations force redeployment when transformer configs change
    # This provides "auto-reload" via pod restart
    checksum/transformer-scripts: {{ include (print $.Template.BasePath "/transformer-configmap.yaml") . | sha256sum }}
{{- end }}
spec:
  replicas: {{ .Values.api.replicaCount }}
  selector:
    matchLabels:
      {{- include "howk.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
  template:
    metadata:
      labels:
        {{- include "howk.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: api
      annotations:
        # Force redeployment when main config changes
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.config.metrics.enabled }}
        prometheus.io/scrape: "true"
        prometheus.io/port: {{ .Values.config.metrics.port | quote }}
        prometheus.io/path: "/metrics"
        {{- end }}
        {{- if .Values.config.transformer.enabled }}
        checksum/transformer-configs: {{ include (print $.Template.BasePath "/transformer-configmap.yaml") . | sha256sum }}
        {{- end }}
    spec:
      enableServiceLinks: false  # Disable auto-injection of service env vars that conflict with config
      {{- if and .Values.config.transformer.enabled .Values.configmapReload.enabled (eq .Values.configmapReload.method "signal") }}
      # Share process namespace so sidecar can send SIGHUP to api container
      shareProcessNamespace: true
      {{- end }}
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: api
          image: "{{ .Values.images.api.repository }}:{{ .Values.images.api.tag }}"
          imagePullPolicy: {{ .Values.images.api.pullPolicy }}
          ports:
            - containerPort: {{ .Values.config.api.port }}
              name: http
            {{- if .Values.config.metrics.enabled }}
            - containerPort: {{ .Values.config.metrics.port }}
              name: metrics
            {{- end }}
          env:
            - name: HOWK_CONFIG
              value: /config/config.yaml
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
            {{- if .Values.config.transformer.enabled }}
            - name: transformer-scripts
              mountPath: /etc/howk/transformers
              readOnly: true
            {{- end }}
          resources:
            {{- toYaml .Values.api.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: {{ .Values.api.livenessProbe.path }}
              port: http
            initialDelaySeconds: {{ .Values.api.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.api.livenessProbe.periodSeconds }}
          readinessProbe:
            httpGet:
              path: {{ .Values.api.readinessProbe.path }}
              port: http
            initialDelaySeconds: {{ .Values.api.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.api.readinessProbe.periodSeconds }}
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 5"]
          {{- if and .Values.config.transformer.enabled .Values.configmapReload.enabled (eq .Values.configmapReload.method "signal") }}
          # Ensure the API runs as PID 1 so sidecar can signal it
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          {{- end }}
        {{- if and .Values.config.transformer.enabled .Values.configmapReload.enabled (eq .Values.configmapReload.method "signal") }}
        # Sidecar that watches ConfigMaps and sends SIGHUP for hot-reload
        - name: configmap-reload
          image: "{{ .Values.configmapReload.image.repository }}:{{ .Values.configmapReload.image.tag }}"
          imagePullPolicy: {{ .Values.configmapReload.image.pullPolicy }}
          env:
            # Watch for changes to transformer ConfigMaps
            - name: LABEL
              value: "app.kubernetes.io/name={{ include "howk.name" . }},app.kubernetes.io/component=transformer"
            - name: LABEL_VALUE
              value: ""
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: METHOD
              value: "SIGNAL"
            - name: SIGNAL
              value: "{{ .Values.configmapReload.signal }}"
            - name: PID
              value: "1"  # API container runs as PID 1 in shared namespace
            - name: SLEEP_TIME
              value: "{{ .Values.configmapReload.sleepTime }}"
          resources:
            {{- toYaml .Values.configmapReload.resources | nindent 12 }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
        {{- end }}
      volumes:
        - name: config
          configMap:
            name: {{ include "howk.fullname" . }}-config
        {{- if .Values.config.transformer.enabled }}
        - name: transformer-scripts
          projected:
            sources:
              - configMap:
                  name: {{ include "howk.fullname" . }}-transformer-scripts
              - configMap:
                  name: {{ include "howk.fullname" . }}-transformer-configs
              {{- if .Values.transformerAuth }}
              - configMap:
                  name: {{ include "howk.fullname" . }}-transformer-auth
              {{- end }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
